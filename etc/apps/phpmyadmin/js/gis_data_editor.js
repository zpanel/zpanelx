var gisEditorLoaded=false;function closeGISEditor(){$("#popup_background").fadeOut("fast");$("#gis_editor").fadeOut("fast",function(){$(this).empty()})}function prepareJSVersion(){$("#gis_editor input[name='gis_data[save]']").val(PMA_messages.strCopy).insertAfter($("#gis_data_textarea")).before("<br/><br/>");$("#gis_data_editor").prepend('<a class="close_gis_editor" href="#">'+PMA_messages.strClose+"</a>");$('<a class="cancel_gis_editor" href="#"> '+PMA_messages.strCancel+"</a>").insertAfter($("input[name='gis_data[save]']"));$("div#gis_data_output p").remove();$("#gis_editor input.add").each(function(c){var b=$(this);b.addClass("addJs").removeClass("add");var a=b.attr("class");b.replaceWith('<a class="'+a+'" name="'+b.attr("name")+'" href="#">+ '+b.val()+"</a>")})}function addDataPoint(a,b){return"<br/>"+$.sprintf(PMA_messages.strPointN,(a+1))+': <label for="x">'+PMA_messages.strX+'</label><input type="text" name="'+b+"["+a+'][x]" value=""/><label for="y">'+PMA_messages.strY+'</label><input type="text" name="'+b+"["+a+'][y]" value=""/>'}function initGISEditorVisualization(){selectVisualization();styleOSM();loadSVG();addZoomPanControllers();zoomAndPan()}function loadJSAndGISEditor(j,h,e,c,a){var f=document.getElementsByTagName("head")[0];var g;var d=["js/jquery/jquery.svg.js","js/jquery/jquery.mousewheel.js","js/jquery/jquery.event.drag-2.0.js","js/tbl_gis_visualization.js"];for(var b=0;b<d.length;b++){g=document.createElement("script");g.type="text/javascript";g.src=d[b];f.appendChild(g)}g=document.createElement("script");g.type="text/javascript";g.onreadystatechange=function(){if(this.readyState=="complete"){loadGISEditor(j,h,e,c,a)}};g.onload=function(){loadGISEditor(j,h,e,c,a)};g.src="js/openlayers/OpenLayers.js";f.appendChild(g);gisEditorLoaded=true}function loadGISEditor(d,e,c,f,b){var a=$("#gis_editor");$.post("gis_data_editor.php",{field:e,value:d,type:c,input_name:f,get_gis_editor:true,token:b,ajax_request:true},function(g){if(g.success==true){a.html(g.gis_editor);initGISEditorVisualization();prepareJSVersion()}else{PMA_ajaxShowMessage(g.error,false)}},"json")}function openGISEditor(){var d=document.documentElement.clientWidth;var h=document.documentElement.clientHeight;var e=d*0.9;var g=h*0.9;var c=h/2-g/2;var b=d/2-e/2;var a=$("#gis_editor");var f=$("#popup_background");a.css({top:c,left:b,width:e,height:g});f.css({opacity:"0.7"});a.append('<div id="gis_data_editor"><img class="ajaxIcon" id="loadingMonitorIcon" src="'+pmaThemeImage+'ajax_clock_small.gif" alt=""/></div>');f.fadeIn("fast");a.fadeIn("fast")}function insertDataAndClose(){var a=$("form#gis_data_editor_form");var b=a.find("input[name='input_name']").val();$.post("gis_data_editor.php",a.serialize()+"&generate=true&ajax_request=true",function(c){if(c.success==true){$("input[name='"+b+"']").val(c.result)}else{PMA_ajaxShowMessage(c.error,false)}},"json");closeGISEditor()}AJAX.registerTeardown("gis_data_editor.js",function(){$("#gis_editor input[name='gis_data[save]']").die("click");$("#gis_editor").die("submit");$("#gis_editor").find("input[type='text']").die("change");$("#gis_editor select.gis_type").die("change");$("#gis_editor a.close_gis_editor, #gis_editor a.cancel_gis_editor").die("click");$("#gis_editor a.addJs.addPoint").die("click");$("#gis_editor a.addLine.addJs").die("click");$("#gis_editor a.addJs.addPolygon").die("click");$("#gis_editor a.addJs.addGeom").die("click")});AJAX.registerOnload("gis_data_editor.js",function(){$("span.open_gis_editor a").removeClass("formLinkSubmit");$("#gis_editor input[name='gis_data[save]']").live("click",function(event){event.preventDefault();insertDataAndClose()});$("#gis_editor").live("submit",function(event){event.preventDefault();insertDataAndClose()});$("#gis_editor").find("input[type='text']").live("change",function(){var $form=$("form#gis_data_editor_form");$.post("gis_data_editor.php",$form.serialize()+"&generate=true&ajax_request=true",function(data){if(data.success==true){$("#gis_data_textarea").val(data.result);$("#placeholder").empty().removeClass("hasSVG").html(data.visualization);$("#openlayersmap").empty();eval(data.openLayers);initGISEditorVisualization()}else{PMA_ajaxShowMessage(data.error,false)}},"json")});$("#gis_editor select.gis_type").live("change",function(event){var $gis_editor=$("#gis_editor");var $form=$("form#gis_data_editor_form");$.post("gis_data_editor.php",$form.serialize()+"&get_gis_editor=true&ajax_request=true",function(data){if(data.success==true){$gis_editor.html(data.gis_editor);initGISEditorVisualization();prepareJSVersion()}else{PMA_ajaxShowMessage(data.error,false)}},"json")});$("#gis_editor a.close_gis_editor, #gis_editor a.cancel_gis_editor").live("click",function(){closeGISEditor()});$("#gis_editor a.addJs.addPoint").live("click",function(){var $a=$(this);var name=$a.attr("name");var prefix=name.substr(0,name.length-11);var $noOfPointsInput=$("input[name='"+prefix+"[no_of_points]']");var noOfPoints=parseInt($noOfPointsInput.val());var html=addDataPoint(noOfPoints,prefix);$a.before(html);$noOfPointsInput.val(noOfPoints+1)});$("#gis_editor a.addLine.addJs").live("click",function(){var $a=$(this);var name=$a.attr("name");var prefix=name.substr(0,name.length-10);var type=prefix.slice(prefix.lastIndexOf("[")+1,prefix.lastIndexOf("]"));var $noOfLinesInput=$("input[name='"+prefix+"[no_of_lines]']");var noOfLines=parseInt($noOfLinesInput.val());var html="<br/>";if(type=="MULTILINESTRING"){html+=PMA_messages.strLineString+" "+(noOfLines+1)+":";var noOfPoints=2}else{html+=PMA_messages.strInnerRing+" "+noOfLines+":";var noOfPoints=4}html+='<input type="hidden" name="'+prefix+"["+noOfLines+'][no_of_points]" value="'+noOfPoints+'"/>';for(var i=0;i<noOfPoints;i++){html+=addDataPoint(i,(prefix+"["+noOfLines+"]"))}html+='<a class="addPoint addJs" name="'+prefix+"["+noOfLines+'][add_point]" href="#">+ '+PMA_messages.strAddPoint+"</a><br/>";$a.before(html);$noOfLinesInput.val(noOfLines+1)});$("#gis_editor a.addJs.addPolygon").live("click",function(){var $a=$(this);var name=$a.attr("name");var prefix=name.substr(0,name.length-13);var $noOfPolygonsInput=$("input[name='"+prefix+"[no_of_polygons]']");var noOfPolygons=parseInt($noOfPolygonsInput.val());var html=PMA_messages.strPolygon+" "+(noOfPolygons+1)+":<br/>";html+='<input type="hidden" name="'+prefix+"["+noOfPolygons+'][no_of_lines]" value="1"/><br/>'+PMA_messages.strOuterRing+':<input type="hidden" name="'+prefix+"["+noOfPolygons+'][0][no_of_points]" value="4"/>';for(var i=0;i<4;i++){html+=addDataPoint(i,(prefix+"["+noOfPolygons+"][0]"))}html+='<a class="addPoint addJs" name="'+prefix+"["+noOfPolygons+'][0][add_point]" href="#">+ '+PMA_messages.strAddPoint+'</a><br/><a class="addLine addJs" name="'+prefix+"["+noOfPolygons+'][add_line]" href="#">+ '+PMA_messages.strAddInnerRing+"</a><br/><br/>";$a.before(html);$noOfPolygonsInput.val(noOfPolygons+1)});$("#gis_editor a.addJs.addGeom").live("click",function(){var $a=$(this);var prefix="gis_data[GEOMETRYCOLLECTION]";var $noOfGeomsInput=$("input[name='"+prefix+"[geom_count]']");var noOfGeoms=parseInt($noOfGeomsInput.val());var html1=PMA_messages.strGeometry+" "+(noOfGeoms+1)+":<br/>";var $geomType=$("select[name='gis_data["+(noOfGeoms-1)+"][gis_type]']").clone();$geomType.attr("name","gis_data["+noOfGeoms+"][gis_type]").val("POINT");var html2="<br/>"+PMA_messages.strPoint+' :<label for="x"> '+PMA_messages.strX+' </label><input type="text" name="gis_data['+noOfGeoms+'][POINT][x]" value=""/><label for="y"> '+PMA_messages.strY+' </label><input type="text" name="gis_data['+noOfGeoms+'][POINT][y]" value=""/><br/><br/>';$a.before(html1);$geomType.insertBefore($a);$a.before(html2);$noOfGeomsInput.val(noOfGeoms+1)})});