function rcube_treelist_widget(K,f){var x,y,z,A;function u(a,b,c){if(a=k[a]){a.collapsed="undefined"==typeof c||c;var d=l(a.id);d.children("ul").first()[a.collapsed?"hide":"show"]();d.children("div.treetoggle").removeClass("collapsed expanded").addClass(a.collapsed?"collapsed":"expanded");t.triggerEvent("toggle",a);window.bw&&(bw.ie6||bw.ie7)&&a.collapsed&&l(a.id).next().children("ul:visible").hide().show();if(b&&a.children)for(d=0;d<a.children.length;d++)u(a.children[d].id,b,c);t.triggerEvent(a.collapsed?
"collapse":"expand",a)}}function D(a,b){u(a,b,!1)}function E(a){p&&(l(p).removeClass("selected"),p=null);var b=l(a);if(b.length){b.addClass("selected");p=a;var c=g.parent(),d=c.scrollTop(),e=b.offset().top-c.offset().top;(0>e||e+b.height()>c.height())&&c.scrollTop(e+d)}t.triggerEvent("select",k[a])}function F(a,b){var c,d,e=a.get(0).id,f=a.children().first().text().toUpperCase();a.parent().children("li"+b).each(function(a,b){0==a&&(c=b);if(b.id!=e)if(b.id!=e&&f>=$(b).children().first().text().toUpperCase())d=
b;else return!1});d?a.insertAfter(d):c.id!=e&&a.insertBefore(c);q=B(g)}function s(a,b,c){if(!a.deleted){var d=$("<li>").attr("id",f.id_prefix+(f.id_encode?f.id_encode(a.id):a.id)).addClass((a.classes||[]).join(" "));c?c.replaceWith(d):d.appendTo(b);"string"==typeof a.html?d.html(a.html):"object"==typeof a.html&&d.append(a.html);a.virtual&&d.addClass("virtual");a.id==p&&d.addClass("selected");if(a.children&&a.children.length)for($('<div class="treetoggle '+(a.collapsed?"collapsed":"expanded")+'">&nbsp;</div>').appendTo(d),
b=$("<ul>").appendTo(d).attr("class",a.childlistclass),a.collapsed&&b.hide(),c=0;c<a.children.length;c++)s(a.children[c],b);return d}}function B(a){var b=[];a.children("li").each(function(a,d){var e=$(d),g=e.children("ul"),f={id:C(e),classes:e.attr("class").split(" "),virtual:e.hasClass("virtual"),html:e.children().first().get(0).outerHTML,children:B(g)};g.length&&(f.childlistclass=g.attr("class"));f.children.length&&(f.collapsed="none"==g.css("display"));e.hasClass("selected")&&(p=f.id);b.push(f);
k[f.id]=f});return b}function G(a){a.id&&(k[a.id]=a);for(var b=0;a.children&&b<a.children.length;b++)G(a.children[b])}function C(a){a=a.attr("id").replace(RegExp("^"+f.id_prefix||"%"),"");return f.id_decode?f.id_decode(a):a}function l(a){a=f.id_encode?f.id_encode(a):a;return $("#"+f.id_prefix+a)}function H(){var a,b,c=g.offset();I=bw.ie?0:window.pageYOffset;r=g.parent().scrollTop();c.top+=r;v=!0;x=c.left;y=c.top;z=c.left+g.width();A=c.top+g.height();w=[];for(var d in k)if(a=l(d),a=a.children().first().get(0),
b=a.offsetHeight)c=$(a).offset(),c.top+=r,w[d]={x1:c.left,y1:c.top,x2:c.left+a.offsetWidth,y2:c.top+b,on:d==n};g.height()>g.parent().height()&&g.parent().mousemove(function(a){var b=0;a=rcube_event.get_mouse_pos(a);a.y-=g.parent().offset().top;25>a.y&&0<r?b=-1:a.y>g.parent().height()-25&&(b=1);v&&0!=b?h||(h=window.setTimeout(function(){J(b)},f.scroll_delay)):h&&(window.clearTimeout(h),h=null)}).mouseleave(function(){h&&(window.clearTimeout(h),h=null)})}function J(a){if(v){var b=r;g.parent().get(0).scrollTop+=
f.scroll_step*a;r=g.parent().scrollTop();h=null;r!=b&&(h=window.setTimeout(function(){J(a)},f.scroll_speed))}}f=$.extend({id_prefix:"",autoexpand:1E3,selectable:!1,scroll_delay:500,scroll_step:5,scroll_speed:20,check_droptarget:function(a){return!a.virtual}},f||{});var g=$(K),q=f.data||[],k={},p=null,v=!1;A=z=y=x=void 0;var w=[],m,n,I=0,r=0,h,t=this;this.container=g;this.expand=D;this.collapse=u;this.select=E;this.render=function(){if(!1!==t.triggerEvent("renderBefore",q)){g.html("");for(var a=0;a<
q.length;a++)s(q[a],g);t.triggerEvent("renderAfter",g)}};this.drag_start=H;this.drag_end=function(){v=!1;h=null;m&&(clearTimeout(m),n=m=null);$("li.droptarget",g).removeClass("droptarget")};this.intersects=function(a,b){var c=bw.ie?-document.documentElement.scrollTop:I,d=g.parent().scrollTop(),e=null;a.top=a.y+d-c;if(a.x<x||a.x>=z||a.top<y||a.top>=A)return $("li.droptarget",g).removeClass("droptarget"),e;for(var h in w)c=w[h],a.x>=c.x1&&a.x<c.x2&&a.top>=c.y1&&a.top<c.y2?(e=k[h],e.children&&e.children.length&&
e.collapsed&&f.autoexpand&&n!=h?(m&&clearTimeout(m),n=h,m=setTimeout(function(){D(n);H();n=null},f.autoexpand)):m&&n!=h&&(clearTimeout(m),m=n=null),f.check_droptarget(e)?(b&&(l(h).addClass("droptarget"),c.on=!0),e=h):e=null):c.on&&(l(h).removeClass("droptarget"),c.on=!1);return e};this.update=function(a,b,c){var d,e=k[a];if(e){d=l(a);if(b.id||b.html||b.children||b.classes)$.extend(e,b),s(e,d.parent(),d);e.id!=a&&(delete k[a],k[e.id]=e);c&&F(d,"string"==typeof c?'[class~="'+c+'"]':"")}};this.insert=
function(a,b,c){var d;(d=b?k[b]:null)?(d.children||(d.children=[]),d.children.push(a),b=l(b),1==d.children.length?(s(d,b.parent(),b),d=l(a.id)):d=s(a,b.children("ul").first())):(q.push(a),d=s(a,g));k[a.id]=a;c&&F(d,"string"==typeof c?'[class~="'+c+'"]':"")};this.remove=function(a){var b,c;return(b=k[a])?(c=l(a),c.remove(),b.deleted=!0,delete k[a],!0):!1};this.get_item=function(a){return l(a).get(0)};this.get_selection=function(){return p};g.length&&(f.data?G({children:q}):q=B(g),g.on("click","div.treetoggle",
function(a){a=C($(this).parent());var b;(b=k[a])&&u(a,void 0,!b.collapsed)}),g.on("click","li",function(a){var b=f.selectable?k[C($(this))]:null;b&&!b.virtual&&(E(b.id),a.stopPropagation())}))}rcube_treelist_widget.prototype.addEventListener=rcube_event_engine.prototype.addEventListener;rcube_treelist_widget.prototype.removeEventListener=rcube_event_engine.prototype.removeEventListener;rcube_treelist_widget.prototype.triggerEvent=rcube_event_engine.prototype.triggerEvent;
